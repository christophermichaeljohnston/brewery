{% extends "base/index.html" %}
{% block content %}
<div class="container-fluid p-3">
  <div class="card card-table">
    <div class="card-header">
      <div class="d-flex flex-row">
        <div>Fermenter</div>
        <div class="btn-toolbar ml-auto" role="toolbar" aria-label="toolbar1">
{% if not fermenter.beer %}
          <div class="btn-group btn-group-sm mr-2" role="group" aria-label="group1">
            <a class="btn btn-light btn-sm" href="{% url 'beer:create' %}"><i class="far fa-plus-square"></i> New</a>
          </div>
{% endif %}
          <div class="btn-group btn-group-sm mr-2" role="group" aria-label="group1">
            <a class="btn btn-light btn-sm" href="{% url 'fermenter:edit' fermenter.id %}"><i class="far fa-edit"></i> Edit</a>
          </div>
        </div>  
      </div>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-borderless table-striped">
        <thead>
          <tr>
            <th>name</th>
            <th>beer</th>
            <th>mode</th>
            <th>setpoint</th>
            <th>temperature</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ fermenter.name }}</td>
            <td>{% if fermenter.beer %}<a class="text-secondary" href="{% url 'beer:detail' fermenter.beer.id %}">{{ fermenter.beer.name }}</a>{% else %}empty{% endif %}</td>
            <td>{{ fermenter.get_mode_display }}</td>
            <td>{{ fermenter.setpoint }} F</td>
            <td>{{ fermenter.temperature }} F <small><small>({{ fermenter.datetime|timesince }} ago)</small></small></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% if fermenter.beer.temperature_set.count > 0 %}
  <div class="card card-table mt-4">
    <div class="card-header">
      <div class="d-flex flex-row">
        <div>History</div>
        <div class="btn-toolbar ml-auto" role="toolbar" aria-label="toolbar2">
          <div class="btn-group btn-group-sm" role="group" aria-label="group1">
            <a class="btn btn-light" href="javascript:drawChart('hour');" role="button">Hour</a>
            <a class="btn btn-light" href="javascript:drawChart('day');" role="button">Day</a>
            <a class="btn btn-light" href="javascript:drawChart('week');" role="button">Week</a>
            <a class="btn btn-light" href="javascript:drawChart('all');" role="button">All</a>
          </div>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div id="chart" style="min-width: 310px; height: 300px; margin: 0 auto"></div>
    </div>
  </div>
{% endif %}
  <div class="card card-table mt-4">
    <div class="card-header">
      Tasks
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-borderless">
        <thead>
          <tr>
            <th>task</th>
            <th>run_at</th>
            <th>last_error</th>
          </tr>
        </thead>
        <tbody>
{% for task in tasks %}
          <tr>
            <td>{{ task.verbose_name }}</td>
            <td class="text-nowrap">{{ task.run_at|timeuntil }}</td>
            <td class="text-nowrap">{{ task.last_error }}</td>
          </tr>
        </tbody>
{% endfor %}
      </table>
    </div>
  </div>
</div>
{% if fermenter.beer %}
<script src="https://code.highcharts.com/highcharts.src.js"></script>
<script>
function drawChart(period) {
  $.getJSON('{% url 'beer:chart_data' fermenter.beer.id %}?period='+period, function(data) {
    $(function () {
      Highcharts.setOptions({
        global: {
          useUTC: false,
        }
      });
      $('#chart').highcharts({
        plotOptions: {
          series: {
            marker: {
              enabled: false
            }
          }
        },
        chart: {
          zoomType: 'x'
        },
        credits: {
          enabled: false
        },
        title: {
          text: ''
        },
        xAxis: {
          type: 'datetime',
        },
        yAxis: {
          title: { text: '' },
          startOnTick: false,
          endOnTick: false,
          minPadding: 0.1,
          maxPadding: 0.1
        },
        legend: {
          enabled: false
        },
        series: [{
          type: 'spline',
          color: 'black',
          name: 'Setpoint',
          data: data['data']['setpoint']
        },{
          type: 'spline',
          color: 'blue',
          name: 'Measured',
          data: data['data']['measured']
        }]
      });
    });
  });
}
$(document).ready(function() {
  drawChart('day');
});
</script>
{% endif %}
{% endblock content %}
